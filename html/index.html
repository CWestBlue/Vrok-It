<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <title>VR Party</title>
        <link
          rel="stylesheet"
          href="https://developer.api.autodesk.com/viewingservice/v1/viewers/style.css"
          type="text/css">
        <script type="text/javascript" src="js/jquery.js"></script>
        <script type="text/javascript" src="js/jquery.qrcode.min.js"></script>
        <script type="text/javascript" src="js/socket.io.js"></script>
        <script
        src="https://developer.api.autodesk.com/viewingservice/v1/viewers/viewer3D.min.js?v=v1.2.14"></script> <!-- ?v=v1.2.13 -->
    </head>
    <body onload="initialize();">
        
        <table>
            <tr style="width:100%; height=100%;">
                <td style="width:20%; height=100%;">
                    <div id="url"></div>
                    <div id="qrcode"></div>
                    <br>
                    <p>Commands:</p>
            
                    <form id="load">
                        <button>Load</button> URN: <input id="load-value" autocomplete="off" value="dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6c3RlYW1idWNrL1JvYm90QXJtLmR3Zng="/>
                    </form>
            
                    <form id="explode">
                        <button>Explode</button> Factor: <input id="explode-value" autocomplete="off" value="1.0"/>
                    </form>
            
                    <form id="isolate">
                        <button>Isolate</button> IDs (comma separated): <input id="isolate-value" autocomplete="off" value="1,2,3"/>
                    </form>
                </td>
                <td style="valign:top; width:80%; height=100%;">
                    <div id='3dViewDiv' style="height: 80%;overflow: hidden;">
                    </div>
                </td>
            </tr>            
        </table>
    </body>
</html>

<script type="text/javascript">

function initialize() {

    var base_url = window.location.origin;
    var url = base_url + '/participant.html';
    $('#url').html("<a href=\"" + url + "\" target=\"_blank\">Participant page</a><br/><br/>");
    $('#qrcode').qrcode(url);
    
    launchUrn();

    var socket = io();

    $('#load').submit(function() {
        var urn = $('#load-value').val();
        socket.emit('lmv-command', { name: 'load', value: urn });
        
        launchUrn(urn);        
        
        return false;
    });

    $('#explode').submit(function() {
        socket.emit('lmv-command', { name: 'explode', value: JSON.parse($('#explode-value').val()) });
        return false;
    });

    $('#isolate').submit(function() {
        socket.emit('lmv-command', { name: 'isolate', value: JSON.parse('[' + $('#isolate-value').val() + ']') });
        return false;
    });
}   

function launchUrn(urn) {       
  $.get(
    window.location.protocol + '//' +
    window.location.host + '/api/token',
    function (accessToken) {

      var options = {};
      options.env = 'AutodeskProduction';
      options.accessToken = accessToken;
      if (urn)
        options.document = urn;
           
      var elem = document.getElementById('3dViewDiv');
      viewer = new Autodesk.Viewing.Private.GuiViewer3D(elem, {});

      Autodesk.Viewing.Initializer(options, function () {
        viewer.initialize();
        loadDocument(viewer, options.document);
      });
    }
  );
}

function loadDocument(viewer, docId) {

  viewer.container.style.width = '80%';
  viewer.resize();

  // Let's zoom in and out of the pivot - the screen
  // real estate is fairly limited - and reverse the
  // zoom direction

  viewer.navigation.setZoomTowardsPivot(true);
  viewer.navigation.setReverseZoomDirection(true);
  viewer.setLightPreset(0);

  if (docId != null) {
    if (docId.substring(0, 4) !== 'urn:')
      docId = 'urn:' + docId;

    Autodesk.Viewing.Document.load(docId,
      function (document) {
  
        // Boilerplate code to load the contents
  
        var geometryItems = [];
  
        if (geometryItems.length == 0) {
          geometryItems =
            Autodesk.Viewing.Document.getSubItemsWithProperties(
              document.getRootItem(),
              { 'type': 'geometry', 'role': '3d' },
              true
            );
        }
        if (geometryItems.length > 0) {
          viewer.load(document.getViewablePath(geometryItems[0]));
        }
  
        // Add our custom progress listener and set the loaded
        // flags to false
  
        //viewer.addEventListener('progress', progressListener);
      },
      function (errorMsg, httpErrorCode) {
        var container = document.getElementById('viewerLeft');
        if (container) {
          alert('Load error ' + errorMsg);
        }
      }
    );
  }
}

</script>
